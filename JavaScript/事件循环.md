## 事件循环

### 9.1 事件循环是什么

主线程从"任务队列"中读取执行事件，这个过程是循环不断的，这个机制被称为事件循环

**JavaScript 的事件分两种**

1. 宏任务：包括整体代码 script，setTimeout，setInterval
2. 微任务：Promise.then(非 new Promise)，process.nextTick(node 中)

**具体执行：**

事件的执行顺序——先执行宏任务，然后执行微任务，任务有同步的任务和异步的任务，同步的进入主线程，异步的进入 Event Table 并注册函数，异步事件完成后，会将回调函数放在队列中，如果还有异步的宏任务，那么就会进行循环执行上述的操作

主线程会不断从任务队列中按顺序取任务执行，每执行完一个任务都会检查microtask队列是否为空（执行完一个 任务的具体标志是函数执行栈为空），如果不为空则会一次性执行完所有microtask。然后再进入下一个循环去 任务队列中取下一个任务执行

**详细步骤**：

1. 选择当前要执行的宏任务队列，选择一个最先进入任务队列的宏任务，如果没有宏任务可以选择，则会 跳转至microtask的执行步骤。

2. 将事件循环的当前运行宏任务设置为已选择的宏任务。
3. 运行宏任务。
4. 将事件循环的当前运行任务设置为null。
5. 将运行完的宏任务从宏任务队列中移除。
6. microtasks步骤：进入microtask检查点。
7. 更新界面渲染。
8. 返回第一步。

**执行进入microtask检查的的具体步骤如下:**

1. 设置进入microtask检查点的标志为true。
2. 当事件循环的微任务队列不为空时：选择一个最先进入microtask队列的microtask；设置事件循环的当前运行任务为已选择的microtask；运行microtask；设置事件循环的当前运行任务为null；将运行结束 的microtask从microtask队列中移除。

3. 对于相应事件循环的每个环境设置对象（environment settings object）,通知它们哪些promise为 rejected。

4. 清理indexedDB的事务。
5. 设置进入microtask检查点的标志为false。

**注意**

当前执行栈执行完毕时会立刻先处理所有微任务队列中的事件,然后再去宏任务队列中取出一个事件。同一次事件循环中,微任务永远在宏任务之前执行

### 9.2 为什么需要事件循环

事件循环是JavaScript执行流程的核心之一，它能够让JavaScript进行非阻塞性I/O操作，即尽管JavaScript是单线程的，但是它可以通过事件和回调函数处理多个操作。

为什么JavaScript需要事件循环呢？

1. 非阻塞I/O：在JavaScript中，一些I/O操作比如网络请求、读写文件、定时器等都是异步的，这些操作通常需要花费较长的一段时间才能完成。此时，如果没有事件循环，那么JavaScript就会一直等待这些操作完成才能进行下一行代码的执行，也就是所谓的阻塞现象。有了事件循环，JavaScript就可以在这些异步操作等待的过程中去执行其他的任务，从而提高了代码的效率和性能。

2. 单线程的并发处理：JavaScript是单线程的，这意味着在任意时间点，JavaScript只能执行一个任务。然而在现实生活中，我们经常需要同时处理多个任务，比如同时处理用户的多个点击事件。如果没有事件循环，JavaScript就无法实现这样的并发处理。有了事件循环，JavaScript可以通过队列和循环来管理和处理这些事件，当一个任务完成后，便可以从队列中获取下一个任务来执行。

3. 任务的排序：在JavaScript中，不同的任务可能会有不同的优先级。例如，解析DOM的任务可能比网络请求的任务优先级更高。事件循环可以通过任务队列，根据任务的种类和优先级来排列和执行这些任务。

简单说，事件循环的存在，让JavaScript在单线程的环境下，能够以异步的方式处理任务，从而更好地提高程序的性能和用户体验。





浏览器为什么是单线程的

浏览器卡顿一般是为何产生的

js的宏任务和微任务，看输入说输出

## 事件循环

### 1 简述事件循环原理

### 2 为什么JS需要事件循环？不设置事件循环不可以吗？

### 3 事件循环里面，哪些是宏任务微任务，为什么需要有这些概念

### 4 在执行微任务的时候又产生了微任务，这个微任务会在什么时候执行