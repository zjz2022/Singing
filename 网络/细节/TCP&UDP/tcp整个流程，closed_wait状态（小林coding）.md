## tcp整个流程，closed_wait状态?（小林coding）

**解析**

> 属于高频考题：`自产《大厂后端Top100面试题讲解｜第82，83，85，86题》`
>
> 所属专项：计算机网络｜TCP&UDP
>
> 专项考察占比：
>
> 【**计算机网络**】面试中考察计算机网络的比率：[大厂：11%](https://mp.weixin.qq.com/s?__biz=Mzk0OTM5MDMzNg==&mid=2247483843&idx=1&sn=7c7bd2c6b906c0ab38c868b84b88da56&chksm=c3585cacf42fd5ba38542da8ac77a7e731b486243c4aaf249d46d91b6c5e0e4e945f9729ad98&token=1036259463&lang=zh_CN&scene=21#wechat_redirect)｜ [腾讯：17%](https://mp.weixin.qq.com/s?__biz=Mzk0OTM5MDMzNg==&mid=2247483854&idx=1&sn=668db515e36dcdc8c180b11abef66e72&chksm=c3585ca1f42fd5b7d399b32a3c909b61a16f13c3bdb6ef6e0461470acdd3955c33a8a0d46120&token=1036259463&lang=zh_CN&scene=21#wechat_redirect)｜ [阿里：7%](https://mp.weixin.qq.com/s?__biz=Mzk0OTM5MDMzNg==&mid=2247483854&idx=1&sn=668db515e36dcdc8c180b11abef66e72&chksm=c3585ca1f42fd5b7d399b32a3c909b61a16f13c3bdb6ef6e0461470acdd3955c33a8a0d46120&token=1036259463&lang=zh_CN&scene=21#wechat_redirect)
>
> 【**计算机网络-TCP&UDP**】面试考察计网时问TCP&UDP问题的比率：[42%](https://mp.weixin.qq.com/s?__biz=Mzk0OTM5MDMzNg==&mid=2247483843&idx=1&sn=7c7bd2c6b906c0ab38c868b84b88da56&chksm=c3585cacf42fd5ba38542da8ac77a7e731b486243c4aaf249d46d91b6c5e0e4e945f9729ad98&token=1036259463&lang=zh_CN&scene=21#wechat_redirect)

### 1. 建立连接的过程？（三次握手）

TCP三次握手是TCP协议中建立连接的重要过程，它涉及客户端和服务器的状态变化以及发送请求的具体内容。

一开始，客户端和服务端都处于CLOSE状态。当服务端准备好接受连接时，它会进入LISTEN状态，等待客户端的连接请求。

第一次握手时，客户端会初始化一个随机序号，并发送一个SYN请求连接报文给服务端，这个报文中包含了客户端的初始序列号。此时，客户端的状态变为SYN-SENT，等待服务端的确认。

服务端收到SYN请求后，会进行第二次握手。服务端也会随机初始化一个序号，并将客户端的序列号加1作为确认应答报文ACK，同时发送自己的SYN报文。这样，服务端发送的就是一个SYN+ACK的报文，此时服务端的状态变为SYN-RCVD。

客户端收到服务端的SYN+ACK报文后，会进行第三次握手。客户端会再次发送一个ACK报文给服务端，确认服务端的SYN报文，并将服务端的ACK序列号加1。此时，客户端的状态变为ESTABLISHED，表示连接已建立。服务端收到客户端的ACK报文后，状态也变为ESTABLISHED。

这个三次握手的过程确保了客户端和服务端都能准确地知道对方已准备好进行数据传输，是TCP协议中保证数据可靠传输的重要机制。

### 断开连接过程？（四次挥手）

首先，我们要明确TCP连接是全双工的，这意味着数据可以在两个方向上同时传输。因此，当一方想要关闭连接时，它需要通知另一方，并确保双方的数据传输都已完成，然后才能完全关闭连接。这就是四次挥手的主要目的。

- 第一次挥手是由客户端发起的。当客户端没有更多的数据要发送时，它会发送一个FIN报文段给服务端。这个FIN报文段的作用是告诉服务端：“我已经没有数据要发送了，你可以开始关闭你那边到我这边的连接了”。同时，客户端会进入FIN_WAIT_1状态，等待服务端的确认。
- 第二次挥手发生在服务端收到FIN报文段后。服务端会发送一个ACK报文段给客户端，作为对FIN报文段的确认。这个ACK报文段的作用是告诉客户端：“我已经收到你的关闭请求了，我这边会准备关闭连接，但是在我发送完所有的数据之前，连接还不会完全关闭”。此时，服务端进入`CLOSE_WAIT`状态，等待所有数据发送完毕。而客户端在收到ACK后，会进入FIN_WAIT_2状态，等待服务端的FIN报文段。
- 第三次挥手发生在服务端发送完所有数据后。此时，服务端会发送一个FIN报文段给客户端，告知客户端它也没有数据要发送了，可以关闭连接了。这个FIN报文段的作用是告诉客户端：“我这边也没有数据要发送了，我们可以关闭连接了”。服务端在发送FIN报文段后，会进入LAST_ACK状态，等待客户端的确认。
- 第四次挥手是客户端在收到服务端的FIN报文段后发起的。客户端会发送一个ACK报文段给服务端，作为对FIN报文段的确认。这个ACK报文段的作用是告诉服务端：“我已经收到你的关闭请求了，我会关闭连接”。在发送完ACK报文段后，客户端会进入TIME_WAIT状态。这个状态会持续一段时间（通常是2MSL，即数据包在网络中的最大生存时间），以确保关闭请求和确认报文段能够被对方正确接收。如果在这段时间内没有收到对方的重新发送请求，那么客户端会最终关闭连接，进入CLOSED状态。而服务端在收到ACK报文段后，会立即关闭连接，进入CLOSED状态。
- 这就是TCP四次挥手的全过程。通过这个过程，TCP连接能够在确保双方数据传输完成的前提下安全地关闭。这个过程的每一步都是必要的，以确保数据的完整性和可靠性。

**推荐学习资料**

- 《小林 Coding》｜图解网络：TCP 三次握手过程是怎样的？
- 《小林 Coding》｜图解网络：TCP 四次挥手过程是怎样的？
